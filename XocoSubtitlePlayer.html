<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xoco Subtitle Player Pro (Maquetaci√≥n Final)</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --dark-bg: #0f172a;
      --surface-bg: #1e293b;
      --glass-bg: rgba(30, 41, 59, 0.8);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --border-subtle: rgba(255, 255, 255, 0.1);
      --shadow-intense: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      --blur-effect: blur(20px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark-bg);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
      user-select: none;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 1;
      transition: var(--transition-smooth);
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid var(--border-subtle);
      border-top: 4px solid transparent;
      border-radius: 50%;
      background: var(--primary-gradient);
      animation: spin 1.2s linear infinite;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-intense);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .loading-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .app-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: var(--dark-bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #video-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 0;
        filter: brightness(0.5);
        display: none;
    }

    .drop-zone {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(102, 126, 234, 0.15);
      border: 4px dashed rgba(102, 126, 234, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9000;
      backdrop-filter: var(--blur-effect);
      animation: pulse 2s ease-in-out infinite;
    }

    .drop-zone.active {
      display: flex;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    .drop-content {
      text-align: center;
      padding: 3rem;
      background: var(--glass-bg);
      border-radius: 24px;
      backdrop-filter: var(--blur-effect);
      box-shadow: var(--shadow-intense);
    }

    .drop-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .drop-text {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .drop-subtext {
      color: var(--text-secondary);
    }

    .upload-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 32px;
      padding: 3rem 2.5rem;
      text-align: center;
      backdrop-filter: var(--blur-effect);
      box-shadow: var(--shadow-intense);
      transition: var(--transition-smooth);
      z-index: 1000;
      max-width: 650px;
      width: 90%;
    }

    .upload-panel.hidden {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
      pointer-events: none;
    }

    .app-title {
      font-size: 2.8rem;
      font-weight: 900;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      text-align: center;
    }

    .app-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      margin-bottom: 2.5rem;
      line-height: 1.6;
    }

    .file-upload-area {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 2.5rem;
    }

    .file-input-group {
      position: relative;
      overflow: hidden;
      border-radius: 20px;
      transition: var(--transition-smooth);
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      padding: 1.8rem 1.5rem;
      background: var(--primary-gradient);
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
      transition: var(--transition-smooth);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .file-input-label:hover {
      transform: scale(1.02);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
    }

    .file-icon {
      font-size: 2.2rem;
    }

    .status-dashboard {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid var(--border-subtle);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1.5rem;
    }

    .status-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      transition: var(--transition-smooth);
    }

    .status-indicator {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: bold;
      transition: var(--transition-smooth);
      flex-shrink: 0;
    }

    .status-indicator.pending { background: var(--warning-color); }
    .status-indicator.success { background: var(--success-color); }
    .status-indicator.error { background: var(--error-color); }

    .status-info {
        text-align: left;
        overflow: hidden;
    }

    .status-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .status-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-container {
      position: absolute;
      top:0; left:0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      z-index: 1;
    }
    
    .video-player {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .video-placeholder {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-secondary);
      z-index: 5;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
    }
    
    .placeholder-icon {
        font-size: 5rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }

    .main-ui-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        pointer-events: none;
    }
    
    .main-ui-overlay > * {
        pointer-events: auto;
    }
    
    .subtitle-overlay {
      position: absolute;
      bottom: 12%;
      left: 5%;
      right: 5%;
      text-align: center;
      transition: var(--transition-smooth);
    }

    .subtitle-text {
      display: inline-block;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 1rem 2rem;
      border-radius: 16px;
      font-size: clamp(1.2rem, 3vw, 2.2rem);
      line-height: 1.5;
      font-weight: 600;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .subtitle-text.active {
      opacity: 1;
      transform: translateY(0);
    }
    
    .subtitle-word {
      transition: color 0.3s ease, transform 0.3s ease;
      display: inline-block;
    }

    .subtitle-word.highlight {
      transform: scale(1.05);
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .controls-overlay {
      position: absolute;
      bottom: 3rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1.5rem;
      align-items: center;
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .app-container:hover .controls-overlay {
      opacity: 1;
    }

    .control-button {
      width: 60px;
      height: 60px;
      border: none;
      border-radius: 50%;
      background: var(--glass-bg);
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition-smooth);
      backdrop-filter: var(--blur-effect);
      border: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .control-button:hover:not(:disabled) {
      background: var(--primary-gradient);
      transform: scale(1.1);
    }

    .control-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .progress-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      cursor: pointer;
    }

    .progress-bar {
      height: 100%;
      background: var(--primary-gradient);
      width: 0%;
      transition: width 0.1s linear;
    }

    .voice-indicator {
      position: absolute;
      top: 2rem;
      right: 2rem;
      display: flex;
      gap: 5px;
      align-items: flex-end;
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .voice-indicator.active {
      opacity: 1;
    }

    .voice-bar {
      width: 4px;
      background: var(--primary-gradient);
      border-radius: 2px;
      animation: voice-wave 0.8s ease-in-out infinite alternate;
    }

    .voice-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
    .voice-bar:nth-child(2) { height: 30px; animation-delay: 0.1s; }
    .voice-bar:nth-child(3) { height: 25px; animation-delay: 0.2s; }
    .voice-bar:nth-child(4) { height: 35px; animation-delay: 0.3s; }
    .voice-bar:nth-child(5) { height: 15px; animation-delay: 0.4s; }

    @keyframes voice-wave {
      0% { transform: scaleY(0.2); opacity: 0.5; }
      100% { transform: scaleY(1); opacity: 1; }
    }

    .settings-panel {
      position: absolute;
      top: 2rem;
      left: 2rem;
      background: var(--glass-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      padding: 1.5rem;
      backdrop-filter: var(--blur-effect);
      opacity: 0;
      transform: translateX(-20px);
      transition: var(--transition-smooth);
      max-width: 320px;
      box-shadow: var(--shadow-intense);
    }

    .app-container:hover .settings-panel {
      opacity: 1;
      transform: translateX(0);
    }

    .settings-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }

    .setting-item {
      margin-bottom: 1.2rem;
    }
    .setting-item:last-child {
        margin-bottom: 0;
    }

    .setting-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .setting-input {
      width: 100%;
      padding: 0.7rem 1rem;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 0.9rem;
      transition: var(--transition-smooth);
    }

    .setting-range {
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      outline: none;
      padding: 0;
    }

    .setting-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--primary-gradient);
      border-radius: 50%;
      cursor: pointer;
    }

    /* NUEVOS ESTILOS PARA INTERRUPTORES (TOGGLES) */
    .toggle-switch-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .toggle-switch-container .setting-label {
        margin-bottom: 0;
    }
    .setting-toggle {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
        flex-shrink: 0;
    }
    .toggle-switch-slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(0,0,0,0.4);
        transition: .4s;
        border-radius: 28px;
    }
    .toggle-switch-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    .setting-toggle:checked + .toggle-switch-slider {
        background: var(--primary-gradient);
    }
    .setting-toggle:disabled + .toggle-switch-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .setting-toggle:checked + .toggle-switch-slider:before {
        transform: translateX(22px);
    }


    .notification {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: var(--glass-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 1rem 1.5rem;
      backdrop-filter: var(--blur-effect);
      box-shadow: var(--shadow-intense);
      z-index: 10000;
      transform: translateX(calc(100% + 2rem));
      transition: var(--transition-smooth);
      min-width: 320px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { border-left: 4px solid var(--success-color); }
    .notification.error { border-left: 4px solid var(--error-color); }
    .notification.warning { border-left: 4px solid var(--warning-color); }

    .notification-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .notification-icon { font-size: 1.8rem; }
    .notification-title { font-weight: 700; margin-bottom: 0.25rem; color: var(--text-primary); }
    .notification-message { font-size: 0.95rem; color: var(--text-secondary); }

    @media (max-width: 768px) {
      .upload-panel { padding: 2rem 1.5rem; }
      .app-title { font-size: 2.2rem; }
      .file-upload-area { grid-template-columns: 1fr; gap: 1rem; }
      .status-grid { grid-template-columns: 1fr; gap: 1rem; }
      .main-ui-overlay, .app-container:hover .controls-overlay, .app-container:hover .settings-panel { opacity: 1; }
      .controls-overlay { bottom: 1.5rem; }
      .settings-panel { top: auto; bottom: 7rem; left: 1rem; right: 1rem; max-width: none; width: calc(100% - 2rem); transform: none; }
      .subtitle-overlay { bottom: 18%; }
      .subtitle-text { padding: 0.8rem 1.2rem; font-size: clamp(1rem, 4vw, 1.5rem); }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Xoco Subtitle Player</div>
    <div class="loading-subtitle">Inicializando sistema avanzado...</div>
  </div>

  <div class="app-container" id="appContainer">
    <video id="video-background" muted loop playsinline></video>
    
    <div class="drop-zone" id="dropZone">
      <div class="drop-content">
        <div class="drop-icon">üìÅ</div>
        <div class="drop-text">Suelta tus archivos aqu√≠</div>
        <div class="drop-subtext">Video (.mp4) + Subt√≠tulos (.srt, .vtt)</div>
      </div>
    </div>

    <div class="upload-panel" id="uploadPanel">
      <h1 class="app-title">üé¨ Xoco Subtitle Player</h1>
      <p class="app-subtitle">
        Sistema profesional de reproducci√≥n con narraci√≥n inteligente.
        Carga tus archivos para comenzar la experiencia.
      </p>
      
      <div class="file-upload-area">
        <div class="file-input-group">
          <input type="file" id="videoInput" class="file-input" accept="video/*">
          <label for="videoInput" class="file-input-label">
            <div class="file-icon">üé•</div>
            <div>Seleccionar Video</div>
          </label>
        </div>
        <div class="file-input-group">
          <input type="file" id="subtitleInput" class="file-input" accept=".srt,.vtt">
          <label for="subtitleInput" class="file-input-label">
            <div class="file-icon">üìù</div>
            <div>Seleccionar Subt√≠tulos</div>
          </label>
        </div>
      </div>

      <div class="status-dashboard">
        <div class="status-grid">
          <div class="status-card">
            <div class="status-indicator pending" id="videoStatusIndicator">‚è≥</div>
            <div class="status-info">
              <div class="status-title">Video</div>
              <div class="status-description" id="videoStatusText">Esperando archivo...</div>
            </div>
          </div>
          <div class="status-card">
            <div class="status-indicator pending" id="subtitleStatusIndicator">‚è≥</div>
            <div class="status-info">
              <div class="status-title">Subt√≠tulos</div>
              <div class="status-description" id="subtitleStatusText">Esperando archivo...</div>
            </div>
          </div>
          <div class="status-card">
            <div class="status-indicator pending" id="systemStatusIndicator">‚è≥</div>
            <div class="status-info">
              <div class="status-title">Sistema</div>
              <div class="status-description" id="systemStatusText">Inicializando...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="video-container">
        <div class="video-placeholder" id="videoPlaceholder">
            <div class="placeholder-icon">üé§</div>
            <h2 class="app-title" style="font-size: 2.5rem;">Modo Solo Voz</h2>
            <p class="app-subtitle" style="font-size: 1.1rem; margin-bottom: 0;">Presiona reproducir para iniciar la narraci√≥n.</p>
        </div>
        <video id="videoPlayer" class="video-player" muted playsinline></video>
    </div>
    
    <div class="main-ui-overlay">
        <div class="subtitle-overlay" id="subtitleOverlay">
            <div class="subtitle-text" id="subtitleText"></div>
        </div>

        <div class="controls-overlay">
            <button class="control-button" id="playPauseBtn" disabled title="Reproducir/Pausar (Espacio)">‚ñ∂Ô∏è</button>
            <button class="control-button" id="stopBtn" disabled title="Detener (Escape)">‚èπÔ∏è</button>
            <button class="control-button" id="fullscreenBtn" title="Pantalla completa (F)" disabled>‚õ∂</button>
        </div>

        <div class="voice-indicator" id="voiceIndicator">
            <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="settings-title">‚öôÔ∏è Configuraci√≥n Avanzada</div>
            <div class="setting-item">
                <label for="voiceSelect" class="setting-label">Voz del Sistema</label>
                <select class="setting-input" id="voiceSelect"><option value="">Cargando voces...</option></select>
            </div>
            <div class="setting-item">
                <label for="voiceRate" class="setting-label">Velocidad de Voz (<span id="voiceRateValue">1.5</span>x)</label>
                <input type="range" class="setting-input setting-range" id="voiceRate" min="0.5" max="2.5" step="0.1" value="1.5">
            </div>
            <div class="setting-item">
                <label for="voicePitch" class="setting-label">Tono de Voz (<span id="voicePitchValue">1.0</span>)</label>
                <input type="range" class="setting-input setting-range" id="voicePitch" min="0.5" max="2" step="0.1" value="1">
            </div>
            <div class="setting-item">
                <label for="fontSize" class="setting-label">Tama√±o Subt√≠tulos (<span id="fontSizeValue">100</span>%)</label>
                <input type="range" class="setting-input setting-range" id="fontSize" min="50" max="200" step="10" value="100">
            </div>
             <div class="setting-item">
                <label for="syncOffset" class="setting-label">Ajuste Sincronizaci√≥n (<span id="syncOffsetValue">0</span> ms)</label>
                <input type="range" class="setting-input setting-range" id="syncOffset" min="-1000" max="1000" step="50" value="0">
            </div>
            <div class="setting-item">
                <div class="toggle-switch-container">
                    <label for="showSubtitlesToggle" class="setting-label">Mostrar Subt√≠tulos</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showSubtitlesToggle" class="setting-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <div class="setting-item">
                 <div class="toggle-switch-container">
                    <label for="karaokeToggle" class="setting-label">Efecto Karaoke</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="karaokeToggle" class="setting-toggle">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>
  </div>

  <script>
    class ExpertSubtitlePlayer {
      constructor() {
        this.dom = {
          loadingScreen: document.getElementById('loadingScreen'),
          uploadPanel: document.getElementById('uploadPanel'),
          videoInput: document.getElementById('videoInput'),
          subtitleInput: document.getElementById('subtitleInput'),
          videoPlayer: document.getElementById('videoPlayer'),
          videoBackground: document.getElementById('video-background'),
          subtitleOverlay: document.getElementById('subtitleOverlay'),
          subtitleText: document.getElementById('subtitleText'),
          playPauseBtn: document.getElementById('playPauseBtn'),
          stopBtn: document.getElementById('stopBtn'),
          fullscreenBtn: document.getElementById('fullscreenBtn'),
          progressBar: document.getElementById('progressBar'),
          progressContainer: document.getElementById('progressContainer'),
          voiceIndicator: document.getElementById('voiceIndicator'),
          settingsPanel: document.getElementById('settingsPanel'),
          voiceSelect: document.getElementById('voiceSelect'),
          voiceRate: document.getElementById('voiceRate'),
          voiceRateValue: document.getElementById('voiceRateValue'),
          voicePitch: document.getElementById('voicePitch'),
          voicePitchValue: document.getElementById('voicePitchValue'),
          fontSize: document.getElementById('fontSize'),
          fontSizeValue: document.getElementById('fontSizeValue'),
          syncOffset: document.getElementById('syncOffset'),
          syncOffsetValue: document.getElementById('syncOffsetValue'),
          videoStatusIndicator: document.getElementById('videoStatusIndicator'),
          videoStatusText: document.getElementById('videoStatusText'),
          subtitleStatusIndicator: document.getElementById('subtitleStatusIndicator'),
          subtitleStatusText: document.getElementById('subtitleStatusText'),
          systemStatusIndicator: document.getElementById('systemStatusIndicator'),
          systemStatusText: document.getElementById('systemStatusText'),
          dropZone: document.getElementById('dropZone'),
          videoPlaceholder: document.getElementById('videoPlaceholder'),
          showSubtitlesToggle: document.getElementById('showSubtitlesToggle'),
          karaokeToggle: document.getElementById('karaokeToggle'),
        };

        this.state = {
          isReady: false, isPlaying: false, hasVideo: false, hasSubtitles: false,
          subtitles: [], currentSubtitleIndex: -1, duration: 0, voices: [],
          settings: this.loadSettings(),
          currentWords: [],
          currentWordSpans: [],
        };

        this.speechSynthesis = window.speechSynthesis;
        this.animationFrame = null;
        this.startTime = 0; this.pausedTime = 0;
        this.init();
      }

      async init() {
        this.updateSystemStatus('pending', 'Inicializando...');
        this.bindEvents();
        this.applySettings();
        
        try {
            await this.initSpeechSynthesis();
            this.updateSystemStatus('success', 'Sistema listo');
            setTimeout(() => this.dom.loadingScreen.classList.add('hidden'), 500);
        } catch (error) {
            this.showNotification('Error al iniciar la s√≠ntesis de voz.', 'error');
            this.updateSystemStatus('error', 'Error de voz');
        }
      }
      
      async initSpeechSynthesis() {
        if (!this.speechSynthesis) throw new Error('S√≠ntesis de voz no soportada');
        return new Promise((resolve) => {
            const loadVoices = () => {
                const voices = this.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    this.state.voices = voices;
                    this.populateVoiceList(); resolve();
                }
            };
            this.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices(); 
            setTimeout(() => {
                if (this.state.voices.length === 0) loadVoices();
                if (this.state.voices.length > 0) { resolve(); }
                else { this.showNotification("No se pudieron cargar las voces.", "warning"); resolve(); }
            }, 1000);
        });
      }

      bindEvents() {
        this.dom.videoInput.addEventListener('change', e => this.handleFile(e.target.files[0], 'video'));
        this.dom.subtitleInput.addEventListener('change', e => this.handleFile(e.target.files[0], 'subtitle'));
        this.dom.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
        this.dom.stopBtn.addEventListener('click', () => this.stop());
        this.dom.fullscreenBtn.addEventListener('click', () => this.toggleFullscreen());
        this.dom.videoPlayer.addEventListener('loadeddata', () => this.onVideoLoaded());
        this.dom.videoPlayer.addEventListener('ended', () => this.stop());
        this.dom.progressContainer.addEventListener('click', e => this.seek(e));

        this.dom.voiceSelect.addEventListener('change', e => this.updateSetting('selectedVoiceURI', e.target.value));
        this.dom.voiceRate.addEventListener('input', e => this.updateSetting('voiceRate', parseFloat(e.target.value), 'voiceRateValue', 'x'));
        this.dom.voicePitch.addEventListener('input', e => this.updateSetting('voicePitch', parseFloat(e.target.value), 'voicePitchValue'));
        this.dom.fontSize.addEventListener('input', e => this.updateSetting('fontSize', parseInt(e.target.value), 'fontSizeValue', '%'));
        this.dom.syncOffset.addEventListener('input', e => this.updateSetting('syncOffset', parseInt(e.target.value), 'syncOffsetValue', ' ms'));
        
        this.dom.showSubtitlesToggle.addEventListener('change', e => this.updateSetting('showSubtitles', e.target.checked));
        this.dom.karaokeToggle.addEventListener('change', e => this.updateSetting('karaokeHighlight', e.target.checked));

        const dropZone = this.dom.dropZone;
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => document.body.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }));
        document.body.addEventListener('dragenter', () => dropZone.classList.add('active'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('active');
            [...e.dataTransfer.files].forEach(file => this.handleFile(file));
        });
        
        document.addEventListener('keydown', e => this.handleKeyPress(e));
      }
      
      async handleFile(file, type = null) {
        if (!file) return;
        const extension = file.name.split('.').pop().toLowerCase();
        if (!type) {
            if (['mp4', 'webm', 'mov', 'ogg'].includes(extension)) type = 'video';
            else if (['srt', 'vtt'].includes(extension)) type = 'subtitle';
        }

        if (type === 'video') {
            this.updateVideoStatus('pending', 'Cargando...');
            try {
                const url = URL.createObjectURL(file);
                this.dom.videoPlayer.src = url;
                this.dom.videoBackground.src = url;
                this.state.hasVideo = true;
                this.updateVideoStatus('success', file.name);
                this.showNotification('Video cargado.', 'success');
            } catch (error) {
                this.updateVideoStatus('error', 'Error al cargar');
                this.showNotification('El archivo de video no es v√°lido.', 'error');
            }
        } else if (type === 'subtitle') {
            this.updateSubtitleStatus('pending', 'Procesando...');
            try {
                const text = await file.text();
                this.state.subtitles = this.parseSubtitles(text);
                 if (this.state.subtitles.length === 0) throw new Error("No se encontraron subt√≠tulos v√°lidos.");
                this.state.hasSubtitles = true;
                this.updateSubtitleStatus('success', `${this.state.subtitles.length} l√≠neas`);
                this.showNotification('Subt√≠tulos procesados.', 'success');
            } catch (error) {
                 this.updateSubtitleStatus('error', 'Error al procesar');
                 this.showNotification(error.message, 'error');
            }
        }
        this.checkIfReady();
      }

      parseSubtitles(content) {
          content = content.replace(/\r/g, '');
          let subtitles = [];
          
          const srtRegex = /(?:^|\n\n)(\d+)\n((?:\d{2}:)?\d{2}:\d{2}[,.]\d{3}) --> ((?:\d{2}:)?\d{2}:\d{2}[,.]\d{3}).*\n([\s\S]+?)(?=\n\n|\n*$)/g;
          let match;
          while ((match = srtRegex.exec(content)) !== null) {
              subtitles.push({ index: parseInt(match[1]), start: this.parseTime(match[2]), end: this.parseTime(match[3]), text: match[4].replace(/<[^>]+>/g, '').trim() });
          }

          if (subtitles.length === 0) {
              const vttRegex = /(?:^|\n\n)((?:\d{2}:)?\d{2}:\d{2}[,.]\d{3}) --> ((?:\d{2}:)?\d{2}:\d{2}[,.]\d{3}).*\n([\s\S]+?)(?=\n\n|\n*$)/g;
              let index = 1;
              while ((match = vttRegex.exec(content)) !== null) {
                  subtitles.push({ index: index++, start: this.parseTime(match[1]), end: this.parseTime(match[2]), text: match[3].replace(/<[^>]+>/g, '').trim() });
              }
          }
          return subtitles;
      }
      
      parseTime(timeStr) {
        const parts = timeStr.split(':');
        const h = parts.length > 2 ? parseInt(parts.shift(), 10) : 0;
        const m = parseInt(parts.shift(), 10);
        const s = parseFloat(parts.shift().replace(',', '.'));
        return (h * 3600 + m * 60 + s) * 1000;
      }

      checkIfReady() {
          this.state.isReady = this.state.hasSubtitles;
          if (this.state.isReady) {
              this.dom.playPauseBtn.disabled = false;
              this.dom.stopBtn.disabled = false;
              this.dom.uploadPanel.classList.add('hidden');
              
              if (this.state.hasVideo) {
                this.dom.fullscreenBtn.disabled = false;
                this.dom.videoPlaceholder.style.display = 'none'; // CORRECCI√ìN BUG
                if (this.dom.videoPlayer.readyState > 0) {
                     this.dom.videoBackground.style.display = 'block';
                }
              } else {
                  this.dom.videoPlaceholder.style.display = 'flex';
              }
          }
      }
      
      onVideoLoaded() {
          this.state.duration = this.dom.videoPlayer.duration * 1000;
          this.checkIfReady();
      }

      togglePlayPause() {
          if (!this.state.isReady) return;
          this.state.isPlaying ? this.pause() : this.play();
      }

      play() {
          if (!this.dom.uploadPanel.classList.contains('hidden')) this.dom.uploadPanel.classList.add('hidden');
          if (!this.state.hasVideo && !this.state.isPlaying) this.startTime = performance.now() - this.pausedTime;
          
          this.state.isPlaying = true;
          if (this.state.hasVideo) this.dom.videoPlayer.play();
          this.dom.playPauseBtn.innerHTML = '‚è∏Ô∏è';
          
          if (!this.animationFrame) this.animationFrame = requestAnimationFrame(this.onTimeUpdate.bind(this));
      }

      pause() {
          this.state.isPlaying = false;
          if (this.state.hasVideo) this.dom.videoPlayer.pause();
          else this.pausedTime = performance.now() - this.startTime;
          
          this.speechSynthesis.cancel();
          this.dom.playPauseBtn.innerHTML = '‚ñ∂Ô∏è';
          this.dom.voiceIndicator.classList.remove('active');
          
          cancelAnimationFrame(this.animationFrame);
          this.animationFrame = null;
      }

      stop() {
          if (this.state.isPlaying) this.pause();
          if (this.state.hasVideo) this.dom.videoPlayer.currentTime = 0;
          
          this.pausedTime = 0; this.startTime = 0;
          this.state.currentSubtitleIndex = -1;
          
          this.dom.progressBar.style.width = '0%';
          this.dom.subtitleText.classList.remove('active');
          this.dom.subtitleText.innerHTML = '';
          
          // Reset UI to initial state
          this.dom.uploadPanel.classList.remove('hidden');
          this.dom.videoBackground.style.display = 'none';
          this.dom.videoPlaceholder.style.display = 'none';
      }
      
      seek(event) {
        if (!this.state.isReady) return;
        const duration = this.state.duration || (this.state.subtitles.length > 0 ? this.state.subtitles[this.state.subtitles.length - 1].end : 0);
        if (!duration) return;
        
        const rect = this.dom.progressContainer.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        const seekTime = duration * percent;

        if (this.state.hasVideo) {
            this.dom.videoPlayer.currentTime = seekTime / 1000;
        } else {
            this.pausedTime = seekTime;
            if (this.state.isPlaying) {
                this.startTime = performance.now() - this.pausedTime;
            }
        }
        this.speechSynthesis.cancel();
        this.onTimeUpdate();
      }

      onTimeUpdate() {
        if (!this.state.isPlaying) return;
        let currentTime, duration;

        if (this.state.hasVideo) {
            currentTime = this.dom.videoPlayer.currentTime * 1000;
            duration = this.dom.videoPlayer.duration * 1000;
        } else {
            currentTime = performance.now() - this.startTime;
            duration = this.state.subtitles.length > 0 ? this.state.subtitles[this.state.subtitles.length - 1].end : 1;
        }
        this.state.duration = duration;
        currentTime += this.state.settings.syncOffset;

        if (duration > 0) this.dom.progressBar.style.width = `${Math.min(100, (currentTime / duration) * 100)}%`;
        
        const activeSubtitle = this.state.subtitles.find(sub => currentTime >= sub.start && currentTime <= sub.end);
        
        if (this.state.settings.showSubtitles) {
            if (activeSubtitle) {
                if (activeSubtitle.index !== this.state.currentSubtitleIndex) {
                    this.handleNewSubtitle(activeSubtitle);
                }
            } else {
                if (this.state.currentSubtitleIndex !== -1) {
                    this.dom.subtitleText.classList.remove('active');
                    this.state.currentSubtitleIndex = -1;
                }
            }
        } else {
            if (activeSubtitle && activeSubtitle.index !== this.state.currentSubtitleIndex) {
                this.speechSynthesis.cancel();
                this.speak(activeSubtitle.text);
                this.state.currentSubtitleIndex = activeSubtitle.index;
            } else if (!activeSubtitle) {
                this.state.currentSubtitleIndex = -1;
            }
        }
        
        if (currentTime >= duration && duration > 1) this.stop();
        if (this.state.isPlaying) this.animationFrame = requestAnimationFrame(this.onTimeUpdate.bind(this));
      }

      handleNewSubtitle(subtitle) {
        this.speechSynthesis.cancel();
        const text = subtitle.text;
        
        if (this.state.settings.karaokeHighlight) {
            const wordRegex = /[\w']+/g;
            let match;
            this.state.currentWords = [];
            let lastIndex = 0;
            let html = '';
            while((match = wordRegex.exec(text)) !== null) {
                html += text.slice(lastIndex, match.index);
                html += `<span class="subtitle-word">${match[0]}</span>`;
                this.state.currentWords.push({ text: match[0], startIndex: match.index });
                lastIndex = match.index + match[0].length;
            }
            html += text.slice(lastIndex);
            this.dom.subtitleText.innerHTML = html;
            this.state.currentWordSpans = this.dom.subtitleText.querySelectorAll('.subtitle-word');
        } else {
            this.dom.subtitleText.textContent = text;
        }

        this.dom.subtitleText.classList.add('active');
        this.state.currentSubtitleIndex = subtitle.index;
        this.speak(text);
      }

      speak(text) {
          if (!text || !this.state.isPlaying) return;
          const utterance = new SpeechSynthesisUtterance(text);
          const { settings, voices } = this.state;
          const selectedVoice = voices.find(v => v.voiceURI === settings.selectedVoiceURI);
          
          utterance.voice = selectedVoice || voices.find(v => v.lang.startsWith('es')) || voices[0];
          utterance.rate = settings.voiceRate;
          utterance.pitch = settings.voicePitch;

          utterance.onstart = () => this.dom.voiceIndicator.classList.add('active');
          
          if (this.state.settings.showSubtitles && this.state.settings.karaokeHighlight) {
              utterance.onboundary = (event) => {
                  if (event.name !== 'word') return;
                  let wordIndex = -1;
                  for (let i = 0; i < this.state.currentWords.length; i++) {
                      if (this.state.currentWords[i].startIndex <= event.charIndex) {
                          wordIndex = i;
                      } else { break; }
                  }
                  if (wordIndex !== -1) {
                      this.state.currentWordSpans.forEach(span => span.classList.remove('highlight'));
                      this.state.currentWordSpans[wordIndex].classList.add('highlight');
                  }
              };
          }

          utterance.onend = () => {
              this.dom.voiceIndicator.classList.remove('active');
              if(this.state.currentWordSpans) {
                this.state.currentWordSpans.forEach(span => span.classList.remove('highlight'));
              }
          };
          
          this.speechSynthesis.speak(utterance);
      }

      loadSettings() {
          try {
              const saved = localStorage.getItem('expertSubtitlePlayerSettingsV4'); // Incremented version
              return saved ? JSON.parse(saved) : this.getDefaultSettings();
          } catch (e) { return this.getDefaultSettings(); }
      }
      saveSettings() { localStorage.setItem('expertSubtitlePlayerSettingsV4', JSON.stringify(this.state.settings)); }
      getDefaultSettings() { 
          return { 
              voiceRate: 1.5, voicePitch: 1, fontSize: 100, syncOffset: 0, 
              selectedVoiceURI: null, showSubtitles: true, karaokeHighlight: true 
          }; 
      }
      
      applySettings() {
          const s = this.state.settings;
          this.dom.voiceRate.value = s.voiceRate; this.dom.voiceRateValue.textContent = s.voiceRate.toFixed(1);
          this.dom.voicePitch.value = s.voicePitch; this.dom.voicePitchValue.textContent = s.voicePitch.toFixed(1);
          this.dom.fontSize.value = s.fontSize; this.dom.fontSizeValue.textContent = s.fontSize;
          this.dom.subtitleText.style.fontSize = `clamp(${s.fontSize*0.8}%, 3vw, ${s.fontSize*1.2}%)`;
          this.dom.syncOffset.value = s.syncOffset; this.dom.syncOffsetValue.textContent = s.syncOffset;
          
          this.dom.showSubtitlesToggle.checked = s.showSubtitles;
          this.dom.subtitleOverlay.style.display = s.showSubtitles ? '' : 'none';
          
          this.dom.karaokeToggle.checked = s.karaokeHighlight;
          this.dom.karaokeToggle.disabled = !s.showSubtitles;
      }
      
      updateSetting(key, value) {
        this.state.settings[key] = value;
        
        if (key === 'showSubtitles') {
            this.dom.subtitleOverlay.style.display = value ? '' : 'none';
            this.dom.karaokeToggle.disabled = !value;
            if(!value) this.dom.subtitleText.classList.remove('active');
        }

        this.saveSettings();
      }
      
      populateVoiceList() {
        const createOptGroup = (label, voices) => {
            const group = document.createElement('optgroup');
            group.label = label;
            voices.forEach(voice => {
                const opt = document.createElement('option');
                opt.value = voice.voiceURI; opt.textContent = `${voice.name} (${voice.lang})`;
                group.appendChild(opt);
            });
            return group;
        };
        this.dom.voiceSelect.innerHTML = '';
        const spanishVoices = this.state.voices.filter(v => v.lang.startsWith('es'));
        if (spanishVoices.length > 0) this.dom.voiceSelect.appendChild(createOptGroup('Voces en Espa√±ol', spanishVoices));
        const otherVoices = this.state.voices.filter(v => !v.lang.startsWith('es'));
        if (otherVoices.length > 0) this.dom.voiceSelect.appendChild(createOptGroup('Otras Voces', otherVoices));

        const defaultVoice = spanishVoices.find(v => v.default) || spanishVoices[0] || this.state.voices[0];
        this.dom.voiceSelect.value = this.state.settings.selectedVoiceURI || (defaultVoice ? defaultVoice.voiceURI : '');
        this.updateSetting('selectedVoiceURI', this.dom.voiceSelect.value);
      }
      
      updateStatus(indicatorId, textId, type, message) {
        const icons = { pending: '‚è≥', success: '‚úÖ', error: '‚ùå' };
        indicatorId.className = `status-indicator ${type}`;
        indicatorId.textContent = icons[type];
        textId.textContent = message;
      }
      updateVideoStatus(t, m) { this.updateStatus(this.dom.videoStatusIndicator, this.dom.videoStatusText, t, m); }
      updateSubtitleStatus(t, m) { this.updateStatus(this.dom.subtitleStatusIndicator, this.dom.subtitleStatusText, t, m); }
      updateSystemStatus(t, m) { this.updateStatus(this.dom.systemStatusIndicator, this.dom.systemStatusText, t, m); }
      
      showNotification(message, type = 'success') {
          const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };
          const titles = { success: '√âxito', error: 'Error', warning: 'Advertencia' };
          const notif = document.createElement('div');
          notif.className = `notification ${type}`;
          notif.innerHTML = `<div class="notification-content"><div class="notification-icon">${icons[type]}</div><div><div class="notification-title">${titles[type]}</div><div class="notification-message">${message}</div></div></div>`;
          document.body.appendChild(notif);
          setTimeout(() => notif.classList.add('show'), 10);
          setTimeout(() => {
              notif.classList.remove('show');
              notif.addEventListener('transitionend', () => notif.remove());
          }, 4000);
      }
      
      toggleFullscreen() {
          if (!this.state.hasVideo) return;
          if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(err => this.showNotification(`No se pudo activar pantalla completa: ${err.message}`, 'error'));
          else document.exitFullscreen();
      }
      
      handleKeyPress(e) {
          if (document.activeElement.tagName === 'INPUT' || e.ctrlKey || e.metaKey) return;
          e.preventDefault();
          switch (e.code) {
              case 'Space': this.togglePlayPause(); break;
              case 'KeyF': this.toggleFullscreen(); break;
              case 'Escape': this.stop(); break;
              case 'ArrowLeft': if (this.state.hasVideo) this.dom.videoPlayer.currentTime = Math.max(0, this.dom.videoPlayer.currentTime - 5); break;
              case 'ArrowRight': if (this.state.hasVideo) this.dom.videoPlayer.currentTime = Math.min(this.state.duration / 1000, this.dom.videoPlayer.currentTime + 5); break;
          }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!('speechSynthesis' in window) || !('Promise' in window)) {
        document.body.innerHTML = `<div style="padding:50px;text-align:center;"><h1>Navegador no compatible</h1><p>Tu navegador no soporta las tecnolog√≠as necesarias para esta aplicaci√≥n.</p></div>`;
        return;
      }
      window.playerApp = new ExpertSubtitlePlayer();
    });
  </script>
</body>
</html>